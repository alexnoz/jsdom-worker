{"version":3,"file":"jsdom-worker.m.js","sources":["../src/index.js"],"sourcesContent":["import mitt from 'mitt';\r\nimport uuid from 'uuid-v4';\r\nimport fetch, { Response } from 'node-fetch';\r\n\r\nif (!global.URL) global.URL = {};\r\nif (!global.URL.$$objects) {\r\n\tglobal.URL.$$objects = new Map();\r\n\tglobal.URL.createObjectURL = blob => {\r\n\t\tlet id = uuid();\r\n\t\tglobal.URL.$$objects[id] = blob;\r\n\t\treturn `blob:http://localhost/${id}`;\r\n\t};\r\n\r\n\tlet oldFetch = global.fetch || fetch;\r\n\tglobal.fetch = function(url, opts) {\r\n\t\tif (url.match(/^blob:/)) {\r\n\t\t\treturn new Promise( (resolve, reject) => {\r\n\t\t\t\tlet fr = new FileReader();\r\n\t\t\t\tfr.onload = () => {\r\n\t\t\t\t\tlet Res = global.Response || Response;\r\n\t\t\t\t\tresolve(new Res(fr.result, { status: 200, statusText: 'OK' }));\r\n\t\t\t\t};\r\n\t\t\t\tfr.onerror = () => {\r\n\t\t\t\t\treject(fr.error);\r\n\t\t\t\t};\r\n\t\t\t\tlet id = url.match(/[^/]+$/)[0];\r\n\t\t\t\tfr.readAsText(global.URL.$$objects[id]);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn oldFetch.call(this, url, opts);\r\n\t};\r\n}\r\n\r\nif (!global.document) {\r\n\tglobal.document = {};\r\n}\r\n\r\nfunction Event(type) { this.type = type; }\r\nEvent.prototype.initEvent = Object;\r\nif (!global.document.createEvent) {\r\n\tglobal.document.createEvent = function(type) {\r\n\t\tlet Ctor = global[type] || Event;\r\n\t\treturn new Ctor(type);\r\n\t};\r\n}\r\n\r\n\r\nglobal.Worker = function Worker(url) {\r\n\tlet messageQueue = [],\r\n\t\tinside = mitt(),\r\n\t\toutside = mitt(),\r\n\t\tscope = {\r\n\t\t\tonmessage: null,\r\n\t\t\tdispatchEvent: inside.emit,\r\n\t\t\taddEventListener: inside.on,\r\n\t\t\tremoveEventListener: inside.off,\r\n\t\t\tpostMessage(data) {\r\n\t\t\t\toutside.emit('message', { data });\r\n\t\t\t},\r\n\t\t\tfetch: global.fetch,\r\n\t\t\timportScripts(...urls) {}\r\n\t\t},\r\n\t\tgetScopeVar;\r\n\tinside.on('message', e => { let f = getScopeVar('onmessage'); if (f) f.call(scope, e); });\r\n\tthis.addEventListener = outside.on;\r\n\tthis.removeEventListener = outside.off;\r\n\tthis.dispatchEvent = outside.emit;\r\n\toutside.on('message', e => { this.onmessage && this.onmessage(e); });\r\n\tthis.postMessage = data => {\r\n\t\tif (messageQueue!=null) messageQueue.push(data);\r\n\t\telse inside.emit('message', { data });\r\n\t};\r\n\tthis.terminate = () => {\r\n\t\tthrow Error('Not Supported');\r\n\t};\r\n\tglobal.fetch(url)\r\n\t\t.then( r => r.text() )\r\n\t\t.then( code => {\r\n\t\t\tlet vars = 'var self=this,global=self';\r\n\t\t\tfor (let k in scope) vars += `,${k}=self.${k}`;\r\n\t\t\tgetScopeVar = eval('(function() {'+vars+';\\n'+code+'\\nreturn function(__){return eval(__)}})').call(scope);\r\n\t\t\tlet q = messageQueue;\r\n\t\t\tmessageQueue = null;\r\n\t\t\tq.forEach(this.postMessage);\r\n\t\t})\r\n\t\t.catch( e => { outside.emit('error', e); console.error(e); });\r\n};\r\n"],"names":["global","URL","$$objects","Map","createObjectURL","blob","let","id","uuid","oldFetch","fetch","url","opts","match","Promise","resolve","reject","fr","FileReader","onload","Res","Response","result","status","statusText","onerror","error","readAsText","call","this","Event","type","document","prototype","initEvent","Object","createEvent","Worker","messageQueue","inside","mitt","outside","scope","onmessage","dispatchEvent","emit","addEventListener","on","removeEventListener","off","postMessage","data","importScripts","getScopeVar","e","f","push","terminate","Error","then","r","text","code","vars","k","eval","q","forEach","catch","console"],"mappings":"yFAKA,GADKA,OAAOC,MAAKD,OAAOC,SACnBD,OAAOC,IAAIC,UAAW,CAC1BF,OAAOC,IAAIC,UAAY,IAAIC,IAC3BH,OAAOC,IAAIG,yBAAkBC,GAC5BC,IAAIC,EAAKC,OAET,OADAR,OAAOC,IAAIC,UAAUK,GAAMF,2BACKE,GAGjCD,IAAIG,SAAWT,OAAOU,OAASA,MAC/BV,OAAOU,MAAQ,SAASC,EAAKC,GAC5B,OAAID,EAAIE,MAAM,UACN,IAAIC,iBAAUC,EAASC,GAC7BV,IAAIW,EAAK,IAAIC,WACbD,EAAGE,kBACFb,IAAIc,EAAMpB,OAAOqB,UAAYA,SAC7BN,EAAQ,IAAIK,EAAIH,EAAGK,QAAUC,OAAQ,IAAKC,WAAY,SAEvDP,EAAGQ,mBACFT,EAAOC,EAAGS,QAEXpB,IAAIC,EAAKI,EAAIE,MAAM,UAAU,GAC7BI,EAAGU,WAAW3B,OAAOC,IAAIC,UAAUK,MAG9BE,SAASmB,KAAKC,KAAMlB,EAAKC,IAQlC,SAASkB,MAAMC,GAAQF,KAAKE,KAAOA,EAJ9B/B,OAAOgC,WACXhC,OAAOgC,aAIRF,MAAMG,UAAUC,UAAYC,OACvBnC,OAAOgC,SAASI,cACpBpC,OAAOgC,SAASI,YAAc,SAASL,GAEtC,OAAO,IADI/B,OAAO+B,IAASD,OACXC,KAKlB/B,OAAOqC,OAAS,SAASA,OAAO1B,qBAC3B2B,gBACHC,OAASC,OACTC,QAAUD,OACVE,OACCC,UAAW,KACXC,cAAeL,OAAOM,KACtBC,iBAAkBP,OAAOQ,GACzBC,oBAAqBT,OAAOU,IAC5BC,qBAAYC,GACXV,QAAQI,KAAK,gBAAaM,KAE3BzC,MAAOV,OAAOU,MACd0C,kFAEDC,YACDd,OAAOQ,GAAG,mBAAWO,GAAOhD,IAAIiD,EAAIF,YAAY,aAAkBE,GAAGA,EAAE3B,KAAKc,MAAOY,KACnFzB,KAAKiB,iBAAmBL,QAAQM,GAChClB,KAAKmB,oBAAsBP,QAAQQ,IACnCpB,KAAKe,cAAgBH,QAAQI,KAC7BJ,QAAQM,GAAG,mBAAWO,GAAOzB,OAAKc,WAAad,OAAKc,UAAUW,KAC9DzB,KAAKqB,qBAAcC,GACA,MAAdb,aAAoBA,aAAakB,KAAKL,GACrCZ,OAAOM,KAAK,gBAAaM,KAE/BtB,KAAK4B,qBACJ,MAAMC,MAAM,kBAEb1D,OAAOU,MAAMC,KACXgD,cAAMC,UAAKA,EAAEC,SACbF,cAAMG,MACNxD,IAAIyD,KAAO,4BACX,IAAKzD,IAAI0D,KAAKtB,MAAOqB,MAAQ,IAAIC,WAAUA,EAC3CX,YAAcY,KAAK,gBAAgBF,KAAK,MAAMD,KAAK,4CAA4ClC,KAAKc,OACpGpC,IAAI4D,EAAI5B,aACRA,aAAe,KACf4B,EAAEC,QAAQtC,OAAKqB,eAEfkB,eAAOd,GAAOb,QAAQI,KAAK,QAASS,GAAIe,QAAQ3C,MAAM4B"}